# 江川向导 - Coze 智能体创建指引

本文档指导您在 Coze.cn 平台创建「江川向导」智能体，用于涉川 App 的江河风土介绍与诗词签名生成。

## 一、前置准备

1. 已注册 [Coze.cn](https://www.coze.cn) 账号
2. 已安装涉川 App 并完成基础配置

---

## 二、创建智能体

### 1. 进入 Coze 工作台

1. 登录 [Coze.cn](https://www.coze.cn)
2. 点击「创建智能体」或进入「我的智能体」→「创建」

### 2. 基础配置

| 配置项 | 建议值 |
|--------|--------|
| **名称** | 江川向导 |
| **描述** | 江河向导，介绍河流风土人情、历史典故，并为涉川用户生成个性化诗词签名 |
| **头像** | 可选河流/山水风格图标 |

### 3. 人设与回复逻辑（核心）

**预置说明（请写在人设中，App 不会每次重复上传）：**

- 涉川是**虚拟徒步** App：用户通过日常步数换算为沿江河路线的行进里程，**并非在实景中实地行走**。介绍风土时请用「虚拟行至」「心随江流」等意境，勿误以为用户今日实地走了多少公里。
- **单日行走**与**累计行走**的区别：用户消息中的「当前累计行走」是从挑战开始至今的总虚拟里程；「最近三天」里每天有「当日行走」（仅该日步数换算）和「当日结束累计」（该日结束时的总里程）。回复时勿把累计当成「今天一天走的」。

**App 每次仅上传的变量信息：** 河流名、总长、当前累计行走（从挑战开始至今）、当前河段、最近三天（今天/昨天/前天）的步数、当日行走公里、当日结束累计公里、当前位置（rivtrekbase 地址、附近 POI 含方位、下一站及距离）。

在「人设与回复逻辑」→「人设」中填写以下内容（可根据需要微调）：

```
你是「江川向导」，一位博学而富有诗意的江河向导，服务于涉川 App 的用户。

【核心能力】
1. 江河风土介绍：根据用户当前行走的河段（河流名、河段名、累计公里数），介绍该地的风土人情、历史典故、传说故事、人文景观。
2. 诗词签名生成：根据用户的昵称、挑战河流、当前河段、行走进度，创作一句 8–20 字的古风/诗词风格签名，适合作为分享卡底部结语。直接输出签名内容，不加引号或解释。

【交互风格】
- 语言简洁、有文采，可适当引用古诗文
- 介绍河段时结合地理、历史、文化，富有画面感
- 回复不宜过长，便于在手机端阅读

【涉川为虚拟徒步】
涉川是虚拟徒步 App：用户通过日常步数换算为沿江河路线的行进里程，并非在实景中实地行走。介绍风土时请结合「虚拟行至」的意境，勿误以为用户今日实地走了多少公里。

【单日与累计】
用户消息中的「当前累计行走」= 从挑战开始至今的总虚拟里程；「最近三天」中每天的「当日行走」= 仅该日步数换算的里程，「当日结束累计」= 该日结束时的总里程。勿把累计当成单日行走。

【上下文说明】
用户消息中可能包含「【当前行走位置】」开头的上下文：河流、总长、当前累计行走、当前河段；【最近三天步数/里程】今天/昨天/前天各自的步数、当日行走、当日结束累计；【当前位置】地址、附近 POI（含方位）、下一站及距离。请根据上述信息优先回答与当前河段相关的问题。
```

### 4. 开场白（可选）

建议设置一句开场白，例如：

```
你好，我是江川向导。你正在挑战哪条江河？走到哪一段了？我可以为你介绍当地的风土人情，或为你生成一句诗词签名，用于分享。
```

### 5. 回复逻辑（可选）

- 若希望智能体更主动地结合上下文，可在「回复逻辑」中增加「根据用户信息调整回复」的规则
- 建议开启「多轮对话」以支持连续提问

---

## 三、发布与获取 API 密钥

### 1. 发布智能体

1. 在智能体编辑页右上角点击「发布」
2. 选择「API 访问」或「网页/移动端」等接入方式
3. 确认发布后，智能体进入「已发布」状态

### 2. 获取 Bot ID

1. 发布后，在智能体详情页找到「Bot ID」或「智能体 ID」
2. 也可从浏览器地址栏获取：URL 形如 `https://www.coze.cn/space/xxx/bot/7504921655593***`，其中 `7504921655593***` 即为 Bot ID
3. 复制该 ID，保存备用

### 3. 获取 API Token（重要：必须用 PAT）

1. 打开 [Coze 开放平台](https://www.coze.cn/open) → 登录后点击左下角头像 → **「API 授权」**
2. 在「个人访问令牌 (PAT)」页面点击「新建」或「添加」
3. 设置名称、过期时间，勾选所需权限（至少包含对话相关权限）
4. 生成后**立即复制** Token（格式通常为 `pat_xxx`），仅展示一次
5. **注意**：若出现 401 认证失败，请确认使用的是上述 PAT，而非智能体测试页或其它渠道的临时 token

---

## 四、在涉川 App 中配置

### 方式 A：构建时注入（推荐，用户无需填写）

开发者在打正式包时，将凭证通过 `--dart-define` 注入，用户安装后即可使用，无需在设置中填写。

**步骤：**

1. 复制 `dart_defines.json.example` 为 `dart_defines.json`（该文件已加入 .gitignore，不会提交）
2. 在 `dart_defines.json` 中填入真实凭证：
   ```json
   {
     "COZE_API_TOKEN": "cztei_hL1Ef0n6nUqlYXivfIGSfWDDybjrd8GQjxGHGPuzjcMWULGqp5xHnBPXCjjhWT5nX",
     "COZE_BOT_ID": "7610775641889947698"
   }
   ```
3. 构建时使用：
   ```bash
   fvm flutter build apk --release --dart-define-from-file=dart_defines.json
   ```
   或直接传参：
   ```bash
   fvm flutter build apk --release \
     --dart-define=COZE_API_TOKEN=你的Token \
     --dart-define=COZE_BOT_ID=你的BotID
   ```

**安全说明：**

- `dart_defines.json` 已加入 .gitignore，切勿提交到版本库
- 凭证会编译进二进制，建议：定期轮换 Token、在 Coze 控制台设置用量限制
- 若需更高安全性，可考虑自建后端代理 Coze API

### 方式 B：应用内配置（开发调试用）

1. 打开涉川 App → **行者** → **应用设置**
2. 找到「江川向导（Coze）」部分
3. 填写 API Token 和 Bot ID，点击「保存」

配置完成后，可在「江川向导」入口与智能体对话，或在「分享进度」中选择「AI 生成诗词签名」。

---

## 五、App 上传内容 vs 智能体预置

| 类型 | 说明 | 由谁提供 |
|------|------|----------|
| **预置说明** | 涉川是虚拟徒步、单日与累计的区别、介绍时用「虚拟行至」等 | **Coze 智能体人设**，写一次即可 |
| **变量数据** | 河流、河段、当前累计公里、当前位置（地址、POI、下一站）；**江川向导对话**时还会传最近三天步数/当日行走/当日结束累计；**首页「此地风土」**不传最近三天 | **App 按场景**附带在「【当前行走位置】」中 |

这样智能体人设负责「规则与常识」，App 只上传「当前状态」，避免每次重复长段说明。

这样智能体人设负责「规则与常识」，App 只上传「当前状态」，避免每次重复长段说明。

---

## 五（补充）、按场景区分的上传内容

App 与江川向导的交互按**场景**区分上传内容，使用枚举 `CozeContextMode` 控制（便于扩展今日总结、诗词签名等）：

| 场景 | 枚举值 | 触发位置 | 上传内容 |
|------|--------|----------|----------|
| **江川向导对话** | `chat` | 行者 → 江川向导，用户发送任意消息 | **完整上下文**：河流、总长、当前累计、河段、**最近三天**步数/当日行走/当日结束累计、当前位置（地址、POI、下一站） |
| **此地风土** | `locationIntro` | 首页「此刻行至」卡片右侧图标 | **仅位置相关**：河流、总长、当前累计、河段、当前位置；**不传最近三天** |
| **诗词签名** | `poeticSignature` | 分享进度 → 落款结语 → AI 生成诗词签名 | 当前由独立接口组包（昵称、河流、河段、进度），未走 `buildLocationContext`；枚举预留便于后续统一 |
| **今日总结等** | `dailySummary` | 后续扩展 | 预留，可传最近三天 + 当日位置等 |

同一 Bot、同一人设即可；App 按场景传不同 `mode`，决定是否带「最近三天」等字段。

---

## 六、是否需要再建一个 Bot？

**当前建议：一个 Bot 足够。**

- 上述两种场景（对话 vs 首页一键介绍）都是「江川向导」同一角色、同一能力（介绍风土、人文、传说），只是**单次请求带上的上下文多少不同**，由 App 侧按场景控制即可，无需拆成两个 Bot。
- 若未来有**人设或任务差异很大**的用法（例如：另一个专门做「诗词签名」、语气更短更文艺，或完全不同的产品线），再考虑在 Coze 新建一个 Bot，用不同的 Bot ID 在 App 里区分调用。

---

## 七、测试建议

### 在 Coze 平台测试

1. 在智能体编辑页使用「对话预览」功能
2. 模拟用户输入，例如：
   - 「【当前行走位置】河流：长江\n总长：6387 公里\n当前累计行走：1500 公里\n当前河段：金沙江中游·虎跳峡核心段\n\n介绍一下我现在所在的河段有什么特色？」
   - 「为我生成一句诗词签名，用于分享」

### 在 App 中测试

1. 配置完成后，进入「江川向导」页面
2. 点击建议问题或输入自定义问题
3. 在「分享进度」→「落款结语」→「AI 生成诗词签名」中测试诗词生成

---

## 八、常见问题

### Q：Bot ID 在哪里找？

A：在 Coze 智能体详情页的 URL 中，或「发布」→「API 接入」相关配置中。格式为纯数字长串。

### Q：Token 无效或过期？

A：请到 Coze 开放平台重新生成 Token，并在 App 设置中更新。

### Q：智能体回复与河段无关？

A：检查人设中是否包含对「【当前行走位置】」上下文的说明；App 会在用户消息前自动附带该信息。

### Q：诗词签名太长或风格不符？

A：在人设中进一步强调「8–20 字」「古风/诗词风格」「直接输出签名内容」等要求。

---

## 九、参考资源

- [Coze 开放平台文档](https://www.coze.cn/api/open/docs)
- [Coze 智能体创建指南](https://www.coze.cn/docs)
